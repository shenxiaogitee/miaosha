# 秒杀功能流程图

## 秒杀系统整体流程

```mermaid
graph TD
    A[用户] -->|1. 获取秒杀路径| B[获取秒杀接口地址]
    B -->|2. 验证码校验| C{验证码校验}
    C -->|验证通过| D[生成秒杀地址]
    C -->|验证失败| E[返回错误]
    D -->|3. 秒杀请求| F[秒杀接口]
    F -->|4. 验证秒杀地址| G{验证秒杀地址}
    G -->|验证失败| H[返回错误]
    G -->|验证通过| I{判断是否已秒杀}
    I -->|已秒杀| J[返回重复秒杀]
    I -->|未秒杀| K{内存标记判断}
    K -->|库存不足| L[返回秒杀结束]
    K -->|库存充足| M[预减库存]
    M -->|5. 入队| N[RabbitMQ]
    N -->|6. 消息出队| O[消息接收处理]
    O -->|7. 判断库存| P{判断库存}
    P -->|库存不足| Q[秒杀失败]
    P -->|库存充足| R{判断是否已秒杀}
    R -->|已秒杀| S[返回重复秒杀]
    R -->|未秒杀| T[减库存下订单]
    T -->|8. 返回秒杀结果| U[秒杀成功]
    A -->|9. 轮询秒杀结果| V[获取秒杀结果]
    V -->|10. 查询秒杀订单| W{判断秒杀结果}
    W -->|秒杀成功| X[返回订单ID]
    W -->|秒杀失败| Y[返回秒杀失败]
    W -->|排队中| Z[返回排队中]
```

## 秒杀系统核心组件

### 1. 系统初始化

```mermaid
graph TD
    A[系统启动] -->|初始化| B[加载商品库存]
    B -->|遍历商品| C[将库存存入Redis]
    C -->|设置标记| D[初始化内存标记]
```

### 2. 秒杀接口地址获取流程

```mermaid
graph TD
    A[用户请求] -->|访问限制检查| B{访问频率检查}
    B -->|超过限制| C[返回错误]
    B -->|未超限制| D{验证码校验}
    D -->|验证失败| E[返回错误]
    D -->|验证通过| F[生成随机秒杀路径]
    F -->|MD5加密| G[存入Redis]
    G -->|返回路径| H[返回秒杀路径]
```

### 3. 秒杀请求处理流程

```mermaid
graph TD
    A[秒杀请求] -->|路径验证| B{验证秒杀路径}
    B -->|验证失败| C[返回非法请求]
    B -->|验证通过| D{检查是否已秒杀}
    D -->|已秒杀| E[返回重复秒杀]
    D -->|未秒杀| F{内存标记检查}
    F -->|库存不足| G[返回秒杀结束]
    F -->|库存充足| H[Redis预减库存]
    H -->|库存<=0| I[设置内存标记]
    I -->|返回| J[返回秒杀结束]
    H -->|库存>0| K[构造秒杀消息]
    K -->|发送消息| L[RabbitMQ队列]
    L -->|返回| M[返回排队中]
```

### 4. 消息队列处理流程

```mermaid
graph TD
    A[接收秒杀消息] -->|解析消息| B[获取用户和商品ID]
    B -->|查询商品| C[获取商品信息]
    C -->|检查库存| D{库存是否充足}
    D -->|库存不足| E[返回秒杀失败]
    D -->|库存充足| F{检查是否已秒杀}
    F -->|已秒杀| G[返回重复秒杀]
    F -->|未秒杀| H[执行秒杀]
    H -->|事务处理| I[减库存下订单]
```

### 5. 秒杀结果查询流程

```mermaid
graph TD
    A[查询秒杀结果] -->|查询订单| B{是否存在订单}
    B -->|存在| C[返回订单ID]
    B -->|不存在| D{检查商品是否售罄}
    D -->|已售罄| E[返回秒杀失败]
    D -->|未售罄| F[返回排队中]
```

## 秒杀系统优化策略

1. **接口限流防刷**：使用AccessLimit注解限制接口访问频率
2. **内存标记**：使用localOverMap内存标记减少Redis访问
3. **Redis预减库存**：减少数据库访问压力
4. **RabbitMQ异步处理**：将秒杀请求异步化，提高系统吞吐量
5. **验证码机制**：防止机器人攻击，削峰填谷
6. **秒杀地址隐藏**：动态生成秒杀地址，防止接口被提前刷
7. **Redis缓存**：大量使用Redis缓存减轻数据库压力