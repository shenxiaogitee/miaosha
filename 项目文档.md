# 秒杀系统项目文档

## 项目概述

这是一个基于Spring Boot的高并发秒杀系统，采用分布式架构设计，通过多种技术手段解决秒杀场景下的高并发、超卖、性能等问题。项目包含多个版本迭代和模块化设计，展示了从单体应用到分布式系统的演进过程。

## 技术栈

- **后端框架**: Spring Boot 2.0.1.RELEASE
- **数据库**: MySQL 5.7+
- **缓存**: Redis
- **消息队列**: RabbitMQ
- **分布式服务**: Dubbo + ZooKeeper
- **模板引擎**: Thymeleaf
- **数据库连接池**: Druid
- **ORM框架**: MyBatis
- **构建工具**: Maven
- **JDK版本**: 1.8

## 项目模块结构

### 1. miaosha-v1 (单体版本)
- **功能**: 基础秒杀功能实现
- **特点**: 单体应用架构，包含完整的秒杀流程
- **核心功能**:
  - 用户登录认证
  - 商品展示
  - 秒杀下单
  - 订单管理
  - 库存管理

### 2. miaosha-v2 (优化版本)
- **功能**: 在v1基础上进行性能优化和架构改进
- **模块划分**:
  - `miaosha-common`: 公共组件和工具类
  - `miaosha-service`: 业务逻辑层
  - `miaosha-web`: Web控制层
- **核心改进**:
  - 引入Dubbo分布式调用
  - 优化库存扣减逻辑
  - 增强缓存策略

### 3. miaosha-admin (管理模块)
- **功能**: 系统管理后台
- **模块划分**:
  - `miaosha-admin-api`: 管理接口定义
  - `miaosha-admin-common`: 管理公共组件
  - `miaosha-admin-service`: 管理业务逻辑
  - `miaosha-admin-web`: 管理Web界面
- **主要功能**:
  - 商品管理
  - 秒杀活动配置
  - 用户管理
  - 系统监控

### 4. miaosha-order (订单模块)
- **功能**: 订单处理服务
- **模块划分**:
  - `miaosha-order-api`: 订单接口定义
  - `miaosha-order-provider`: 订单服务提供者
- **核心功能**:
  - 订单创建
  - 订单状态管理
  - 订单查询
  - 分布式事务处理

### 5. miaosha-rpc (分布式服务模块)
- **功能**: 基于Dubbo的分布式服务调用
- **模块划分**:
  - `dubbo-api`: 服务接口定义
  - `dubbo-consumer`: 服务消费者
  - `dubbo-provider`: 服务提供者
- **配置**:
  - 注册中心: ZooKeeper (39.107.245.253:2181)
  - 服务超时: 6000ms
  - 重试次数: 3次

## 数据库设计

### 核心表结构

1. **goods (商品表)**
   - `id`: 商品ID (主键)
   - `goods_name`: 商品名称
   - `goods_title`: 商品标题
   - `goods_img`: 商品图片
   - `goods_detail`: 商品详情
   - `goods_price`: 商品单价
   - `goods_stock`: 商品库存

2. **miaosha_goods (秒杀商品表)**
   - `id`: 秒杀商品ID (主键)
   - `goods_id`: 关联商品ID
   - `miaosha_price`: 秒杀价格
   - `stock_count`: 秒杀库存
   - `start_date`: 秒杀开始时间
   - `end_date`: 秒杀结束时间

3. **miaosha_order (秒杀订单表)**
   - `id`: 订单ID (主键)
   - `user_id`: 用户ID
   - `order_id`: 订单ID
   - `goods_id`: 商品ID
   - 唯一索引: `u_uid_gid` (user_id, goods_id) - 防止重复购买

## 核心技术方案

### 1. 防止超卖解决方案
- **数据库层面**: SQL加判断防止库存为负数
- **缓存层面**: Redis预减库存减少数据库访问
- **内存标记**: 减少Redis访问次数
- **唯一索引**: 防止用户重复购买

### 2. 性能优化策略

#### 缓存策略
- **页面级缓存**: 使用ThymeleafViewResolver缓存渲染页面
- **对象级缓存**: Redis永久缓存对象减少数据库压力
- **库存预减**: Redis预减库存，内存标记减少Redis访问

#### 异步处理
- **消息队列**: RabbitMQ处理订单队列
- **异步下单**: 请求先入队缓冲，异步处理订单
- **轮询检查**: 客户端定时轮询检查秒杀结果

### 3. 分布式Session解决方案
- 生成随机UUID作为Cookie返回
- Redis存储Session信息
- 拦截器自动获取用户对象
- HandlerMethodArgumentResolver自动注入用户参数

### 4. 安全防护措施

#### 接口安全
- **接口隐藏**: 秒杀接口动态生成路径
- **验证码**: 数字公式验证码防止机器刷单
- **防刷限流**: @AccessLimit注解实现接口访问限制

#### 分布式锁
- **Redis分布式锁**: 多版本实现，从简单到复杂
- **Redisson框架**: 成熟的分布式锁解决方案
- **Lua脚本**: 保证操作原子性

### 5. 限流策略
- **Lua脚本限流**: 基于Redis + Lua实现分布式限流
- **时间窗口**: 控制单位时间内的访问次数
- **IP/手机号限流**: 多维度限流控制

## 消息队列设计

### RabbitMQ配置
- **Exchange持久化**: 保证消息不丢失
- **Queue持久化**: 队列持久化存储
- **消息持久化**: MessageDeliveryMode.persistent
- **手动确认**: 确保消息被正确处理

### 消息处理流程
1. 请求进入队列缓冲
2. 异步处理秒杀请求
3. 生成订单，扣减库存
4. 客户端轮询获取结果

## 分布式事务处理

### TCC事务补偿
1. **Try阶段**: 预留资源，初始化流程
2. **Confirm阶段**: 确认执行，提交事务
3. **Cancel阶段**: 取消执行，回滚操作
4. **定时任务**: 处理异常订单回滚

## 部署和运行

### 环境要求
- JDK 1.8+
- MySQL 5.7+
- Redis 3.0+
- RabbitMQ 3.6+
- ZooKeeper 3.4+

### 启动顺序
1. 启动ZooKeeper
2. 启动Redis
3. 启动RabbitMQ
4. 启动MySQL并导入SQL脚本
5. 启动各个服务模块

### 配置文件
- 数据库配置: `application.properties`
- Dubbo配置: `spring.dubbo.registry=zookeeper://39.107.245.253:2181`
- Redis配置: 根据实际环境配置

## 性能测试和优化

### 压测工具
- JMeter进行压力测试
- 监控QPS、响应时间、错误率

### 优化建议
1. **数据库优化**: 避免全表扫描，合理使用索引
2. **缓存优化**: 合理设置缓存过期时间
3. **连接池优化**: 调整数据库连接池大小
4. **JVM优化**: 调整堆内存和GC参数

## 监控和运维

### 访问统计
- 利用Lua脚本进行Redis操作
- 登录时记录访问统计
- 支持自定义统计时段

### 服务降级
- **自动降级**: 超时、失败次数、故障、限流触发
- **人工降级**: 重大活动期间手动降级
- **熔断机制**: 过载保护，防止系统崩溃

## 项目特色

1. **渐进式架构**: 从单体到分布式的完整演进
2. **多种解决方案**: 提供多种技术方案对比
3. **生产级代码**: 考虑了实际生产环境的各种问题
4. **详细文档**: 完整的技术文档和问题解决方案
5. **性能优化**: 多层次的性能优化策略

## 学习建议

### 推荐学习顺序
1. **miaosha-v1**: 理解基础秒杀流程
2. **miaosha-v2**: 学习性能优化技巧
3. **miaosha-rpc**: 掌握分布式服务调用
4. **miaosha-admin**: 了解管理后台设计
5. **miaosha-order**: 学习订单服务拆分

### 重点关注模块
- **MiaoshaController**: 秒杀核心控制器
- **MiaoshaService**: 秒杀业务逻辑
- **RedisService**: 缓存服务封装
- **MQSender/MQReceiver**: 消息队列处理
- **分布式锁实现**: 多种分布式锁方案

## 扩展方向

1. **微服务改造**: 基于Spring Cloud进行微服务拆分
2. **容器化部署**: Docker + Kubernetes部署
3. **监控完善**: 集成Prometheus + Grafana监控
4. **日志分析**: ELK日志分析系统
5. **自动化运维**: CI/CD流水线建设

---

*本文档基于项目代码分析生成，如有疑问请参考源码实现。*